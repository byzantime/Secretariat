{% extends "base.html" %}

{% block title %}Secretariat{% endblock %}

{% block extra_head %}
<!-- Mobile input optimization -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
    /* Override base template to allow full-height layout with white background */
    body {
        background: white;
        /* Prevent unwanted zoom on mobile when inputs are focused */
        touch-action: manipulation;
    }
    #main-content {
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- top control panel -->
<div class="px-4 py-3 border-b border-gray-200 flex-shrink-0 bg-white">
    <div class="flex items-center justify-between gap-2 mb-2">
        <span class="text-sm font-semibold text-gray-900">Secretariat</span>
        <span class="inline-block px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700 whitespace-nowrap" id="status">
            Connecting...
        </span>
    </div>
    <div class="text-sm text-gray-700 mb-3 leading-relaxed">
        {{ reason }}
        <div id="keyboard-status" class="text-xs text-gray-500 mt-1"></div>
    </div>
    <button
        id="show-keyboard-btn"
        class="hidden w-full px-4 py-2.5 mb-2 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-sm rounded-lg font-medium transition-colors"
    >
        ðŸ“± Show Keyboard
    </button>
    <button
        id="done-btn"
        class="w-full px-4 py-2.5 bg-green-600 hover:bg-green-700 active:bg-green-800 text-white text-sm rounded-lg font-medium transition-colors"
    >
        Done
    </button>
</div>

<!-- Viewer container - takes remaining space below control panel -->
<div class="flex-1 min-h-0 bg-white">
    <div class="h-full overflow-auto scrollbar-w-8 scrollbar-h-8 scrollbar scrollbar-thumb-gray-400 scrollbar-track-transparent scrollbar-thumb-rounded">
        <iframe
            id="vnc-frame"
            src="{{ novnc_url }}"
            allow="clipboard-read; clipboard-write"
            class="w-full h-full min-w-[1280px] min-h-[720px] border border-gray-200"
            allowfullscreen
            sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals"
            loading="eager"
        ></iframe>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const statusEl = document.getElementById('status');
    const vncFrame = document.getElementById('vnc-frame');
    const doneBtn = document.getElementById('done-btn');

    // Update status when iframe loads
    vncFrame.addEventListener('load', () => {
        statusEl.textContent = 'Connected';
        statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700 whitespace-nowrap';

        // Auto-show keyboard on mobile devices with polling
        if ('ontouchstart' in window) {
            console.log('Mobile device detected - will auto-show keyboard');

            let keyboardTriggered = false;
            let attemptCount = 0;
            const maxAttempts = 15; // 15 attempts * 200ms = 3 seconds
            const pollInterval = 200; // Check every 200ms

            function tryTriggerKeyboard() {
                if (keyboardTriggered) return true;

                try {
                    const iframeDoc = vncFrame.contentDocument || vncFrame.contentWindow?.document;

                    if (!iframeDoc) {
                        console.log('Iframe document not accessible yet');
                        return false;
                    }

                    // Wait for noVNC to fully initialize - check if UI elements exist
                    const container = iframeDoc.getElementById('noVNC_container');
                    if (!container) {
                        console.log('noVNC not fully initialized yet');
                        return false;
                    }

                    // Try to click the keyboard button (preferred method)
                    const keyboardBtn = iframeDoc.getElementById('noVNC_keyboard_button');
                    if (keyboardBtn && !keyboardBtn.disabled) {
                        console.log('Found keyboard button, clicking it');
                        keyboardBtn.click();
                        keyboardTriggered = true;
                        return true;
                    }

                    // Fallback: Try to focus the keyboard input directly
                    const keyboardInput = iframeDoc.getElementById('noVNC_keyboardinput');
                    if (keyboardInput) {
                        console.log('Found keyboard input, focusing it');
                        keyboardInput.focus();
                        try {
                            const l = keyboardInput.value.length;
                            keyboardInput.setSelectionRange(l, l);
                        } catch (err) {
                            // setSelectionRange may fail on some browsers
                        }
                        keyboardTriggered = true;
                        return true;
                    }

                    return false;
                } catch (err) {
                    console.log('Error accessing iframe:', err.message);
                    return false;
                }
            }

            // Polling function to retry keyboard trigger
            function pollForKeyboard() {
                attemptCount++;
                console.log(`Keyboard trigger attempt ${attemptCount}/${maxAttempts}`);

                const success = tryTriggerKeyboard();

                if (success) {
                    console.log('âœ“ Keyboard triggered successfully');
                    // Show success indicator briefly
                    const indicator = document.getElementById('keyboard-status');
                    if (indicator) {
                        indicator.textContent = 'âœ“ Keyboard ready';
                        indicator.className = 'text-xs text-green-600 mt-1';
                        setTimeout(() => indicator.remove(), 3000);
                    }
                } else if (attemptCount < maxAttempts) {
                    // Continue polling
                    setTimeout(pollForKeyboard, pollInterval);
                } else {
                    console.log('âœ— Failed to auto-trigger keyboard after all attempts');
                    // Show fallback button
                    const fallbackBtn = document.getElementById('show-keyboard-btn');
                    if (fallbackBtn) {
                        fallbackBtn.classList.remove('hidden');
                    }
                }
            }

            // Start polling after a short delay to let iframe begin loading
            setTimeout(pollForKeyboard, 500);

            // Also try on first user touch interaction as a backup
            vncFrame.addEventListener('touchstart', () => {
                if (!keyboardTriggered) {
                    tryTriggerKeyboard();
                }
            }, { once: true, passive: true });
        }
    });

    // Handle errors
    vncFrame.addEventListener('error', () => {
        statusEl.textContent = 'Failed';
        statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700 whitespace-nowrap';
    });

    // Handle Show Keyboard button click
    const showKeyboardBtn = document.getElementById('show-keyboard-btn');
    if (showKeyboardBtn) {
        showKeyboardBtn.addEventListener('click', () => {
            try {
                const iframeDoc = vncFrame.contentDocument || vncFrame.contentWindow?.document;
                if (iframeDoc) {
                    // Try clicking the keyboard button
                    const keyboardBtn = iframeDoc.getElementById('noVNC_keyboard_button');
                    if (keyboardBtn) {
                        keyboardBtn.click();
                        showKeyboardBtn.classList.add('hidden');
                        const indicator = document.getElementById('keyboard-status');
                        if (indicator) {
                            indicator.textContent = 'âœ“ Keyboard opened';
                            indicator.className = 'text-xs text-green-600 mt-1';
                        }
                        return;
                    }

                    // Fallback: focus keyboard input
                    const keyboardInput = iframeDoc.getElementById('noVNC_keyboardinput');
                    if (keyboardInput) {
                        keyboardInput.focus();
                        showKeyboardBtn.classList.add('hidden');
                        const indicator = document.getElementById('keyboard-status');
                        if (indicator) {
                            indicator.textContent = 'âœ“ Keyboard focused';
                            indicator.className = 'text-xs text-green-600 mt-1';
                        }
                    }
                }
            } catch (err) {
                console.error('Failed to show keyboard:', err);
                const indicator = document.getElementById('keyboard-status');
                if (indicator) {
                    indicator.textContent = 'âœ— Could not access keyboard';
                    indicator.className = 'text-xs text-red-600 mt-1';
                }
            }
        });
    }

    // Handle Done button click
    const sessionId = '{{ session_id }}';
    doneBtn.addEventListener('click', async () => {
        try {
            // Mark session as complete via API
            const response = await fetch(`/auth/complete/${sessionId}`, {
                method: 'POST'
            });

            if (response.ok) {
                statusEl.textContent = 'Completed';
                statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700 whitespace-nowrap';
                doneBtn.disabled = true;
                doneBtn.classList.add('opacity-50', 'cursor-not-allowed');
                setTimeout(() => window.close(), 2000);
            }
        } catch (e) {
            statusEl.textContent = 'Error';
            statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700 whitespace-nowrap';
        }
    });
</script>
{% endblock %}
