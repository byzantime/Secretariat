{% extends "base.html" %}

{% block title %}Secretariat{% endblock %}

{% block extra_head %}
<!-- Mobile input optimization -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
    /* Override base template to allow full-height layout with white background */
    body {
        background: white;
        /* Prevent unwanted zoom on mobile when inputs are focused */
        touch-action: manipulation;
    }
    #main-content {
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- top control panel -->
<div class="px-4 py-3 border-b border-gray-200 flex-shrink-0 bg-white">
    <div class="text-sm text-gray-700 mb-3 leading-relaxed">
        {{ reason }}
    </div>
    <div class="flex items-center justify-between gap-2">
        <button
            id="show-keyboard-btn"
            class="w-full px-4 py-2.5 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-sm rounded-lg font-medium transition-colors"
        >
            ðŸ“± Show Keyboard
        </button>
        <button
            id="done-btn"
            class="w-full px-4 py-2.5 bg-green-600 hover:bg-green-700 active:bg-green-800 text-white text-sm rounded-lg font-medium transition-colors"
        >
            Done
        </button>
    </div>
</div>

<!-- Viewer container - takes remaining space below control panel -->
<div class="flex-1 min-h-0 bg-white">
    <div id="iframe-container" class="h-full w-full overflow-auto scrollbar-w-8 scrollbar-h-8 scrollbar scrollbar-thumb-gray-400 scrollbar-track-transparent scrollbar-thumb-rounded flex justify-center">
        <iframe
            id="vnc-frame"
            src="{{ novnc_url }}"
            allow="clipboard-read; clipboard-write"
            class="w-full h-full"
            allowfullscreen
            sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals"
            loading="eager"
        ></iframe>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const vncFrame = document.getElementById('vnc-frame');
    const doneBtn = document.getElementById('done-btn');
    const iframeContainer = document.getElementById('iframe-container');

    // Function to focus keyboard input using noVNC's mechanism
    function focusKeyboardInput() {
        try {
            const iframeDoc = vncFrame.contentDocument || vncFrame.contentWindow?.document;
            if (!iframeDoc) {
                console.log('Iframe document not accessible');
                return false;
            }

            const keyboardInput = iframeDoc.getElementById('noVNC_keyboardinput');
            if (keyboardInput) {
                console.log('Focusing keyboard input');
                keyboardInput.focus({ preventScroll: true });
                try {
                    const l = keyboardInput.value.length;
                    keyboardInput.setSelectionRange(l, l);
                } catch (err) {
                    // setSelectionRange may fail on some browsers
                }
                return true;
            }
            return false;
        } catch (err) {
            console.log('Error accessing iframe:', err.message);
            return false;
        }
    }


    // Handle Show Keyboard button click
    const showKeyboardBtn = document.getElementById('show-keyboard-btn');
    if (showKeyboardBtn) {
        showKeyboardBtn.addEventListener('click', () => {
            focusKeyboardInput();
        });
    }

    // Handle Done button click
    const sessionId = '{{ session_id }}';
    doneBtn.addEventListener('click', async () => {
        try {
            // Mark session as complete via API
            const response = await fetch(`/auth/complete/${sessionId}`, {
                method: 'POST'
            });

            if (response.ok) {
                doneBtn.disabled = true;
                doneBtn.classList.add('opacity-50', 'cursor-not-allowed');
                setTimeout(() => window.close(), 2000);
            }
        } catch (e) {
            console.error('Error completing session:', e);
        }
    });
</script>
{% endblock %}
