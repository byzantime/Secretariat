{% extends "base.html" %}

{% block title %}Human Assistance - {{ url }}{% endblock %}

{% block extra_head %}
<style>
    /* Override base template to allow full-height layout with white background */
    body {
        background: white;
    }
    #main-content {
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- Viewer container - takes remaining space -->
<div class="flex-1 flex items-center justify-center p-2 min-h-0 bg-white">
    <iframe
        id="vnc-frame"
        src="{{ novnc_url }}"
        allow="clipboard-read; clipboard-write"
        class="w-full h-full border border-gray-200"
    ></iframe>
</div>

<!-- Header - bottom control panel -->
<div class="px-4 py-3 border-t border-gray-200 flex-shrink-0 bg-white">
    <div class="flex items-center justify-between gap-2 mb-2">
        <span class="text-sm font-semibold text-gray-900">Secretariat</span>
        <span class="inline-block px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700 whitespace-nowrap" id="status">
            Connecting...
        </span>
    </div>
    <div class="text-sm text-gray-700 mb-3 leading-relaxed">
        {{ reason }}
    </div>
    <button
        id="done-btn"
        class="w-full px-4 py-2.5 bg-green-600 hover:bg-green-700 active:bg-green-800 text-white text-sm rounded-lg font-medium transition-colors"
    >
        Done
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
    const statusEl = document.getElementById('status');
    const vncFrame = document.getElementById('vnc-frame');
    const doneBtn = document.getElementById('done-btn');

    // Update status when iframe loads
    vncFrame.addEventListener('load', () => {
        statusEl.textContent = 'Connected';
        statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700 whitespace-nowrap';
    });

    // Handle errors
    vncFrame.addEventListener('error', () => {
        statusEl.textContent = 'Failed';
        statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700 whitespace-nowrap';
    });

    // Handle Done button click
    const sessionId = '{{ session_id }}';
    doneBtn.addEventListener('click', async () => {
        try {
            // Mark session as complete via API
            const response = await fetch(`/auth/complete/${sessionId}`, {
                method: 'POST'
            });

            if (response.ok) {
                statusEl.textContent = 'Completed';
                statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700 whitespace-nowrap';
                doneBtn.disabled = true;
                doneBtn.classList.add('opacity-50', 'cursor-not-allowed');
                setTimeout(() => window.close(), 2000);
            }
        } catch (e) {
            statusEl.textContent = 'Error';
            statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700 whitespace-nowrap';
        }
    });

    // Poll for assistance completion (also detects automatic completion via URL change)
    let pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`/auth/status/${sessionId}`);
            const data = await response.json();

            if (data.completed) {
                clearInterval(pollInterval);
                statusEl.textContent = 'Completed';
                statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700 whitespace-nowrap';
                setTimeout(() => window.close(), 2000);
            }
        } catch (e) {
            // Ignore polling errors
        }
    }, 2000);
</script>
{% endblock %}
