{% extends "base.html" %}

{% block title %}Secretariat{% endblock %}

{% block extra_head %}
<!-- Mobile input optimization -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
    /* Override base template to allow full-height layout with white background */
    body {
        background: white;
        /* Prevent unwanted zoom on mobile when inputs are focused */
        touch-action: manipulation;
    }
    #main-content {
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- top control panel -->
<div class="px-4 py-3 border-b border-gray-200 flex-shrink-0 bg-white">
    <div class="text-sm text-gray-700 mb-3 leading-relaxed">
        {{ reason }}
        <span id="keyboard-status" class="text-xs text-gray-500 mt-1"></span>
    </div>
    <div class="flex items-center justify-between gap-2">
        <button
            id="show-keyboard-btn"
            class="w-full px-4 py-2.5 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-sm rounded-lg font-medium transition-colors"
        >
            üì± Show Keyboard
        </button>
        <button
            id="done-btn"
            class="w-full px-4 py-2.5 bg-green-600 hover:bg-green-700 active:bg-green-800 text-white text-sm rounded-lg font-medium transition-colors"
        >
            Done
        </button>
    </div>
</div>

<!-- Mobile keyboard activation overlay -->
<div id="keyboard-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 m-4 text-center shadow-xl">
        <div class="text-6xl mb-4">‚å®Ô∏è</div>
        <div class="text-xl font-semibold text-gray-900 mb-2">Tap to use Keyboard</div>
        <div class="text-sm text-gray-600">Tap anywhere to enable keyboard input</div>
    </div>
</div>

<!-- Viewer container - takes remaining space below control panel -->
<div class="flex-1 min-h-0 bg-white">
    <div class="h-full overflow-auto scrollbar-w-8 scrollbar-h-8 scrollbar scrollbar-thumb-gray-400 scrollbar-track-transparent scrollbar-thumb-rounded">
        <iframe
            id="vnc-frame"
            src="{{ novnc_url }}"
            allow="clipboard-read; clipboard-write"
            class="w-full h-full min-w-[1280px] min-h-[720px] border border-gray-200"
            allowfullscreen
            sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals"
            loading="eager"
        ></iframe>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const statusEl = document.getElementById('status');
    const vncFrame = document.getElementById('vnc-frame');
    const doneBtn = document.getElementById('done-btn');

    // Detect mobile device
    const isMobile = 'ontouchstart' in window;
    const overlay = document.getElementById('keyboard-overlay');

    // Function to focus keyboard input using noVNC's mechanism
    function focusKeyboardInput() {
        try {
            const iframeDoc = vncFrame.contentDocument || vncFrame.contentWindow?.document;
            if (!iframeDoc) {
                console.log('Iframe document not accessible');
                return false;
            }

            const keyboardInput = iframeDoc.getElementById('noVNC_keyboardinput');
            if (keyboardInput) {
                console.log('Focusing keyboard input');
                keyboardInput.focus();
                try {
                    const l = keyboardInput.value.length;
                    keyboardInput.setSelectionRange(l, l);
                } catch (err) {
                    // setSelectionRange may fail on some browsers
                }
                return true;
            }
            return false;
        } catch (err) {
            console.log('Error accessing iframe:', err.message);
            return false;
        }
    }

    // Update status when iframe loads
    vncFrame.addEventListener('load', () => {
        statusEl.textContent = 'Connected';
        statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700 whitespace-nowrap';

        // Show overlay on mobile to capture user gesture
        if (isMobile) {
            console.log('Mobile device detected - showing tap overlay');
            overlay.classList.remove('hidden');
        }
    });

    // Handle overlay tap to trigger keyboard (requires user gesture)
    if (overlay) {
        overlay.addEventListener('click', () => {
            console.log('Overlay tapped - attempting to focus keyboard');

            const success = focusKeyboardInput();

            // Hide overlay
            overlay.classList.add('hidden');
        }, { once: true });
    }

    // Handle errors
    vncFrame.addEventListener('error', () => {
        statusEl.textContent = 'Failed';
        statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700 whitespace-nowrap';
    });

    // Handle Show Keyboard button click (fallback)
    const showKeyboardBtn = document.getElementById('show-keyboard-btn');
    if (showKeyboardBtn) {
        showKeyboardBtn.addEventListener('click', () => {
            focusKeyboardInput();
        });
    }

    // Handle Done button click
    const sessionId = '{{ session_id }}';
    doneBtn.addEventListener('click', async () => {
        try {
            // Mark session as complete via API
            const response = await fetch(`/auth/complete/${sessionId}`, {
                method: 'POST'
            });

            if (response.ok) {
                statusEl.textContent = 'Completed';
                statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700 whitespace-nowrap';
                doneBtn.disabled = true;
                doneBtn.classList.add('opacity-50', 'cursor-not-allowed');
                setTimeout(() => window.close(), 2000);
            }
        } catch (e) {
            statusEl.textContent = 'Error';
            statusEl.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700 whitespace-nowrap';
        }
    });
</script>
{% endblock %}
