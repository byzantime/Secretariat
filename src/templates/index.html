{% extends "base.html" %}
{% from "jinja_ui_kit/components/input/macro.html" import input %}
{% from "jinja_ui_kit/components/button/macro.html" import button %}

{% block content %}
<!-- Three-section flexbox layout -->
<div class="h-screen flex flex-col bg-gray-100">

    <!-- 1. Conversation area (fills available space, can shrink when others grow) -->
    <div id="conversation-area"
         class="flex-initial h-[calc(100vh-130px)] overflow-y-auto bg-white"
         sse-swap="streaming_text"
         hx-swap="beforeend scroll:bottom"
         _="on htmx:afterSwap go to the bottom of me smoothly">

        <div class="max-w-4xl mx-auto space-y-4 p-4">
            <div class="text-center text-gray-500 py-8">
                <h1 class="text-xl text-black font-semibold uppercase mb-2">Secretariat</h1>
                <p>Ask me anything and I'll help you with tools and information.</p>
            </div>
        </div>
    </div>

    <!-- 2. Status area (auto size, grows with content, doesn't shrink below content) -->
    <div class="flex-auto bg-gray-50 border-t border-gray-200 px-4 py-2 text-sm text-gray-600">
        <div class="max-w-4xl mx-auto"
             id="status-line"
             sse-swap="status_update"
             hx-swap="innerHTML">
            Ready
        </div>
    </div>

    <!-- 3. Input area (auto size, grows with content, doesn't shrink below content) -->
    <div class="flex-auto bg-white border-t border-gray-200 p-4">
        <div class="max-w-4xl mx-auto">
            <form id="input-form"
                  hx-post="{{ url_for('main.send_message') }}"
                  hx-trigger="submit"
                  hx-swap="none"
                  class="flex gap-3 items-center"
                  _="on submit reset() me">

                <div class="flex-1">
                    {{ input({
                        'id': 'message-input',
                        'name': 'message',
                        'type': 'text',
                        'placeholder': 'Ask me anything...',
                        'required': true,
                        'autofocus': true,
                        'autocomplete': 'off',
                        'label': {
                            'text': 'Message',
                            'classes': 'sr-only'
                        },
                        'classes': 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
                        'formGroup': {
                            'classes': 'mb-0'
                        }
                    }) }}
                </div>

                {{ button({
                    'text': 'Send',
                    'type': 'submit',
                    'id': 'submit-btn',
                    'variant': 'primary',
                    'classes': 'px-6 py-3',
                    'attributes': {
                        '_': 'on htmx:beforeRequest add @disabled to me then put \'Sending...\' into me on htmx:afterRequest remove @disabled from me then put \'Send\' into me'
                    }
                }) }}

                <!-- Stop button (inline, hidden by default) -->
                {{ button({
                    'text': 'Stop',
                    'id': 'stop-btn',
                    'variant': 'warning',
                    'classes': 'px-4 py-3 hidden ml-2',
                    'attributes': {
                        'hx-post': '{{ url_for(\'main.stop\') }}',
                        'hx-swap': 'none',
                        '_': 'on htmx:beforeRequest add @disabled to me on htmx:afterRequest remove @disabled from me'
                    }
                }) }}
            </form>
        </div>
    </div>
</div>

<!-- Dummy main to prevent template issues -->
<main class="hidden">
{% endblock %}

{% block scripts %}
<script type="text/hyperscript">
    -- Handle SSE events for automation state management
    on htmx:sseMessage[detail.type == 'automation_started'] from body
        remove .hidden from #stop-btn
        add @disabled to #message-input
        add @disabled to #submit-btn
    end

    on htmx:sseMessage[detail.type == 'automation_complete'] from body
        add .hidden to #stop-btn
        remove @disabled from #message-input
        remove @disabled from #submit-btn
        set #message-input.value to ''
        call #message-input.focus()
    end

    on htmx:sseMessage[detail.type == 'streaming_text'] from body
        wait 100ms then go to the bottom of #conversation-area smoothly
    end
    on htmx:sseMessage[detail.type == 'status_update'] from body
        wait 100ms then go to the bottom of #conversation-area smoothly
    end
</script>
{% endblock %}
