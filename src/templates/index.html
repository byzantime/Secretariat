{% extends "base.html" %}

{% block title %}Apparat - AI Assistant{% endblock %}

{% block content %}
<!-- Override base template padding - close main and create fixed layout -->
</main>

<!-- Full viewport fixed layout -->
<div class="fixed inset-0 flex flex-col bg-gray-100">

    <!-- Main conversation area (fills remaining space) -->
    <div id="conversation-area"
         class="flex-1 overflow-y-auto bg-white"
         style="margin-bottom: 7rem;"
         sse-swap="conversation_message"
         hx-swap="beforeend"
         _="on htmx:afterSwap go to the bottom of me smoothly">

        <div class="max-w-4xl mx-auto space-y-4 p-4">
            <div class="text-center text-gray-500 py-8">
                <h1 class="text-2xl font-semibold mb-2">Apparat AI Assistant</h1>
                <p>Tell me what you'd like me to do, and I'll help you automate it.</p>
            </div>
        </div>
    </div>

    <!-- Status line (fixed above input) -->
    <div class="fixed bottom-20 left-0 right-0 bg-gray-50 border-t border-gray-200 px-4 py-2 text-sm text-gray-600 z-40">
        <div class="max-w-4xl mx-auto"
             id="status-line"
             sse-swap="automation_status"
             hx-swap="innerHTML">
            Ready
        </div>
    </div>

    <!-- Input area (fixed at bottom) -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-50 h-20">
        <div class="max-w-4xl mx-auto">
            <form id="input-form"
                  hx-post="/automation/start"
                  hx-trigger="submit"
                  hx-swap="none"
                  class="flex gap-3 items-center h-12"
                  _="on submit reset() me">

                <div class="flex-1">
                    <input type="text"
                           id="task-input"
                           name="task"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-12"
                           placeholder="What would you like me to do?"
                           required
                           autofocus
                           _="on load focus() me
                              on keydown[key=='Enter' and not shiftKey]
                                 halt the event
                                 then trigger submit on #input-form">
                </div>

                <button type="submit"
                        id="submit-btn"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors h-12"
                        _="on htmx:beforeRequest add @disabled to me then put 'Sending...' into me
                           on htmx:afterRequest remove @disabled from me then put 'Send' into me">
                    Send
                </button>

                <!-- Stop button (inline, hidden by default) -->
                <button id="stop-btn"
                        hx-post="/automation/stop"
                        hx-swap="none"
                        class="px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 hidden transition-colors h-12 ml-2"
                        _="on htmx:beforeRequest add @disabled to me
                           on htmx:afterRequest remove @disabled from me">
                    Stop
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Dummy main to prevent template issues -->
<main class="hidden">
{% endblock %}

{% block scripts %}
<script type="text/hyperscript">
    -- Handle SSE events for automation state management
    on htmx:sseMessage[detail.type == 'automation_started'] from body
        remove .hidden from #stop-btn
        add @disabled to #task-input
        add @disabled to #submit-btn
    end

    on htmx:sseMessage[detail.type == 'automation_complete'] from body
        add .hidden to #stop-btn
        remove @disabled from #task-input
        remove @disabled from #submit-btn
        set #task-input.value to ''
        call #task-input.focus()
    end

    on htmx:sseMessage[detail.type == 'conversation_message'] from body
        wait 100ms then go to the bottom of #conversation-area smoothly
    end
</script>
{% endblock %}
